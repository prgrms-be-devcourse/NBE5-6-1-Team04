<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.grepp.spring.app.model.cart.repository.CartRepository">

  <resultMap id="cartItemDto" type="CartItemDto">
    <result property="id" column="cart_item_id"/>
    <result property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="productCount" column="product_count"/>
    <result property="price" column="price"/>
    <result property="thumbnailUrl" column="product_image_id"/>
    <result property="totalPrice" column="total_price"/>
  </resultMap>

  <select id="findCartItemsByUserId" resultMap="cartItemDto">
    SELECT DISTINCT
      ci.order_item_id as cart_item_id,
      ci.product_id,
      p.product_name,
      ci.product_count,
      p.price,
      MIN(pi.product_image_id) as product_image_id,
      (ci.product_count * p.price) as total_price
    FROM cart_item ci
    JOIN cart c ON ci.cart_id = c.cart_id
    JOIN product p ON ci.product_id = p.product_id
    LEFT JOIN product_image pi ON p.product_id = pi.product_id AND pi.type = 'thumbnail'
    WHERE c.user_id = #{userId}
    GROUP BY ci.order_item_id, ci.product_id, p.product_name, ci.product_count, p.price
  </select>

  <select id="findCartIdByUserId" resultType="Long">
    SELECT cart_id
    FROM cart
    WHERE user_id = #{userId}
  </select>

  <insert id="insertCartItem" parameterType="CartItem">
    INSERT INTO cart_item (order_item_id, cart_id, product_id, product_count)
    VALUES (#{orderItemId}, #{cartId}, #{productId}, #{productCount})
  </insert>

  <select id="findCartItemById" resultType="CartItem">
    SELECT *
    FROM cart_item
    WHERE order_item_id = #{cartItemId}
  </select>

  <select id="isCartItemOwnedByUser" resultType="boolean">
    SELECT COUNT(*) > 0
    FROM cart_item ci
    JOIN cart c ON ci.cart_id = c.cart_id
    WHERE ci.order_item_id = #{cartItemId}
    AND c.user_id = #{userId}
  </select>

  <select id="existsById" resultType="boolean">
    SELECT COUNT(*) > 0
    FROM cart_item
    WHERE order_item_id = #{cartItemId}
  </select>

  <update id="updateCartItemCount">
    UPDATE cart_item
    SET product_count = #{productCount}
    WHERE order_item_id = #{cartItemId}
  </update>

  <delete id="deleteCartItem">
    DELETE FROM cart_item
    WHERE order_item_id = #{cartItemId}
  </delete>

  <delete id="deleteAllCartItems">
    DELETE FROM cart_item
    WHERE cart_id = #{cartId}
  </delete>

</mapper>
